<%- include('partials/header', { title: 'Admin', user }) %>

<section class="grid two">
  <article class="card">
    <h2>Neue Aufgabe</h2>
    <form action="/admin/tasks" method="POST" class="stack">
      <label>Titel <input name="title" required /></label>
      <label>Beschreibung <textarea name="description" rows="3"></textarea></label>
      <label>Priorität
        <select name="priority" required>
          <option value="low">low</option>
          <option value="medium" selected>medium</option>
          <option value="high">high</option>
          <option value="critical">critical</option>
        </select>
      </label>
      <label>Deadline <input type="date" name="deadline" /></label>
      <button class="btn primary" type="submit">Aufgabe erstellen</button>
    </form>
  </article>

  <article class="card">
    <h2>Filter</h2>
    <form method="GET" action="/admin" class="stack">
      <label>Status
        <select name="status">
          <option value="">Alle</option>
          <% ['open','in_progress','done'].forEach(s => { %>
            <option value="<%= s %>" <%= filters.status===s?'selected':'' %>><%= s %></option>
          <% }) %>
        </select>
      </label>
      <label>Priorität
        <select name="priority">
          <option value="">Alle</option>
          <% ['low','medium','high','critical'].forEach(p => { %>
            <option value="<%= p %>" <%= filters.priority===p?'selected':'' %>><%= p %></option>
          <% }) %>
        </select>
      </label>
      <label>Monat <input type="month" name="month" value="<%= filters.month %>" /></label>
      <button class="btn">Anwenden</button>
    </form>
  </article>
</section>

<section class="card">
  <h2>Aufgaben verwalten</h2>
  <div class="table-wrap">
    <table>
      <thead><tr><th>ID</th><th>Task</th><th>Status</th><th>Deadline</th><th>Bearbeiten</th><th>Löschen</th></tr></thead>
      <tbody>
      <% if (!tasks.length) { %>
        <tr><td colspan="6" class="muted">Keine Aufgaben gefunden.</td></tr>
      <% } %>
      <% tasks.forEach(task => { %>
        <tr>
          <td>#<%= task.id %></td>
          <td>
            <strong><%= task.title %></strong>
            <div class="muted small"><%= task.description || '-' %></div>
            <span class="pill <%= task.priority %>"><%= task.priority %></span>
          </td>
          <td><span class="pill status <%= task.status %>"><%= task.status %></span></td>
          <td><%= formatDate(task.deadline) %></td>
          <td>
            <form action="/admin/tasks/<%= task.id %>/update" method="POST" class="stack compact">
              <input name="title" value="<%= task.title %>" required />
              <input name="description" value="<%= task.description || '' %>" />
              <div class="row">
                <select name="priority">
                  <% ['low','medium','high','critical'].forEach(p => { %>
                    <option value="<%= p %>" <%= task.priority===p?'selected':'' %>><%= p %></option>
                  <% }) %>
                </select>
                <select name="status">
                  <% ['open','in_progress','done'].forEach(s => { %>
                    <option value="<%= s %>" <%= task.status===s?'selected':'' %>><%= s %></option>
                  <% }) %>
                </select>
              </div>
              <div class="row">
                <input type="date" name="deadline" value="<%= task.deadline || '' %>" />
                <input type="number" step="0.25" min="0" name="hours_spent" value="<%= task.hours_spent || 0 %>" />
              </div>
              <button class="btn" type="submit">Update</button>
            </form>
          </td>
          <td>
            <form action="/admin/tasks/<%= task.id %>/delete" method="POST" onsubmit="return confirm('Wirklich löschen?')">
              <button class="btn danger" type="submit">Löschen</button>
            </form>
          </td>
        </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
</section>

<section class="grid two">
  <article class="card">
    <h2>Dennis' Verfügbarkeit</h2>
    <ul class="simple-list">
      <% if (!availability.length) { %>
        <li class="muted">Noch keine Einträge.</li>
      <% } %>
      <% availability.forEach(row => { %>
        <li>
          <strong><%= formatDate(row.date) %></strong>
          — <%= formatHours(row.hours) %>h
          <% if (row.time_slot) { %> | <%= row.time_slot %><% } %>
          <% if (row.note) { %> | <span class="muted"><%= row.note %></span><% } %>
        </li>
      <% }) %>
    </ul>
  </article>

  <article class="card">
    <div class="card-head">
      <h2>Monatsbericht (<%= filters.month %>)</h2>
      <a class="btn" href="/admin/report.csv?month=<%= filters.month %>">CSV Export</a>
    </div>
    <p class="kpi"><span>Gesamtstunden:</span> <strong><%= formatHours(reportTotal) %>h</strong></p>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Aufgabe</th><th>Stunden</th><th>Status</th><th>Datum</th></tr></thead>
        <tbody>
        <% if (!reportRows.length) { %>
          <tr><td colspan="4" class="muted">Keine Daten in diesem Monat.</td></tr>
        <% } %>
        <% reportRows.forEach(row => { %>
          <tr>
            <td><%= row.title %></td>
            <td><%= formatHours(row.hours_spent) %>h</td>
            <td><%= row.status %></td>
            <td><%= formatDate(row.completed_at) %></td>
          </tr>
        <% }) %>
        </tbody>
      </table>
    </div>
  </article>
</section>

<%- include('partials/footer') %>
